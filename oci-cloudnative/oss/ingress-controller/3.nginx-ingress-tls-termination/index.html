<!DOCTYPE html>
<html lang="ko">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>4.1.3 NGINX Ingress Controller에서 TLS termination - TheKoguryo&#39;s 기술 블로그 | Oracle Cloud Native</title>
<meta name="generator" content="Hugo 0.89.2" />
<link href="https://thekoguryo.github.io/oci-cloudnativeindex.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="https://thekoguryo.github.io/oci-cloudnative/oss/ingress-controller/3.nginx-ingress-tls-termination/">
<link rel="stylesheet" href="https://thekoguryo.github.io/oci-cloudnative/css/theme.min.css">
<link rel="stylesheet" href="https://thekoguryo.github.io/oci-cloudnative/css/d2coding.css">
<link rel="stylesheet" href="https://thekoguryo.github.io/oci-cloudnative/css/fontawesome-all.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="https://thekoguryo.github.io/oci-cloudnative/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://thekoguryo.github.io/oci-cloudnative/js/functions.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="https://thekoguryo.github.io/oci-cloudnative/js/jquery.backtothetop/jquery.backtothetop.min.js"></script>
<script src="https://thekoguryo.github.io/oci-cloudnative/js/jqcloud/jqcloud.js"></script>
<link rel="stylesheet" href="https://thekoguryo.github.io/oci-cloudnative/js/jqcloud/jqcloud.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106207316-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-106207316-1');
</script>
</head>
<body>
<div class="container"><header>
<h1>TheKoguryo&#39;s 기술 블로그 | Oracle Cloud Native</h1>

 <span class="version">Version 2021.12.01</span>
<a href="https://github.com/TheKoguryo" class="github"><i class="fab fa-github"></i></a>
</header>
<div class="menu">
<nav>
<ul>
<li ><a href="https://thekoguryo.github.io">Home</a></li>
<li ><a href="/oci-cloudnative/">Oracle Cloud Native</a></li>
<li ><a href="https://github.com/TheKoguryo/TheKoguryo.github.io/issues/new">Feedback</a></li></ul>
</nav>
</div>
<div class="content-container">
<main><h1 id="413-nginx-ingress-controller에서-tls-terminationfeats-lets-encrypt">4.1.3 NGINX Ingress Controller에서 TLS termination(feats. Let&rsquo;s Encrypt)</h1>
<p>Ingress Controller에서 외부 수신을 SSL로 하기 위한 설정을 확인합니다.</p>
<h2 id="self-signed-인증서-사용하기">Self-Signed 인증서 사용하기</h2>
<p>테스트 목적으로 Self-Signed 인증서를 만들어 사용하는 방법을 확인해 봅니다. 실제 환경에서는 공인 인증기관에서 발급받은 인증서를 사용합니다. Self-Signed 인증서 발급 절차만 대체되어 TLS Secret 등록과정부터는 동일하게 수행됩니다.</p>
<p>참고 문서</p>
<ul>
<li><a href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengsettingupingresscontroller.htm">https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengsettingupingresscontroller.htm</a></li>
</ul>
<h3 id="인증서-만들기">인증서 만들기</h3>
<ol>
<li>
<p>Cloud Shell 또는 작업환경에서 다음 명령으로 인증서를 생성합니다. 공인 인증기관에서 발급받은 인증서 사용시 하지 않아도 됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="s2">&#34;/CN=nginxsvc/O=nginxsvc&#34;</span>
</code></pre></div></li>
<li>
<p>TLS Secret을 만듭니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl create secret tls tls-secret --key tls.key --cert tls.crt
</code></pre></div></li>
<li>
<p>실행결과</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">oke_admin@cloudshell:~ <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="s2">&#34;/CN=nginxsvc/O=nginxsvc&#34;</span>
Generating a <span class="m">2048</span> bit RSA private key
*************************************************************************************************************************************************************+++++
****************************************************************************************************************************+++++
writing new private key to <span class="s1">&#39;tls.key&#39;</span>
-----
oke_admin@cloudshell:~ <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ kubectl create secret tls tls-secret --key tls.key --cert tls.crt
secret/tls-secret created
</code></pre></div></li>
</ol>
<h3 id="tls-ingress-자원-배포">TLS Ingress 자원 배포</h3>
<ol>
<li>
<p>테스트를 위한 샘플 앱을 배포합니다. PATH 기반 라우팅 때 사용한 앱을 그대로 사용합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl create deployment nginx-blue --image<span class="o">=</span>thekoguryo/nginx-hello:blue
kubectl expose deployment nginx-blue --name nginx-blue-svc --port <span class="m">80</span>
kubectl create deployment nginx-green --image<span class="o">=</span>thekoguryo/nginx-hello:green
kubectl expose deployment nginx-green --name nginx-green-svc --port <span class="m">80</span>
</code></pre></div></li>
<li>
<p>ingress 설정 YAML(<code>tls-termination.yaml</code>)을 작성합니다.</p>
<ul>
<li>spec.tls.secretName으로 앞서 생성한 Self-Signed 인증서 이름을 사용합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-tls-termination</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">tls-secret</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">blue.ingress.thekoguryo.ml</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-blue-svc</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">green.ingress.thekoguryo.ml</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-green-svc</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></div></li>
<li>
<p>기존 테스트 ingress는 삭제하고, 작성한 <code>tls-termination.yaml</code>을 배포합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">oke_admin@cloudshell:~ <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ kubectl apply -f tls-termination.yaml 
ingress.networking.k8s.io/ingress-tls-termination created
oke_admin@cloudshell:~ <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ kubectl get ingress
NAME                      CLASS    HOSTS                                                    ADDRESS   PORTS     AGE
ingress-tls-termination   &lt;none&gt;   blue.ingress.thekoguryo.ml,green.ingress.thekoguryo.ml             80, <span class="m">443</span>   5s
</code></pre></div></li>
</ol>
<h3 id="tls-적용-결과-검증">TLS 적용 결과 검증</h3>
<ol>
<li>
<p>ingress rule에서 적용한 host 명으로 각각 접속하여 결과를 확인합니다.</p>
<p>아래와 같이 https로 접속되고 Self-Signed 인증서로 인한 경고 메시지가 뜹니다.</p>
<p>







<img class="img-fluid1" src="../images/image-20211207124621301.png" alt='image-20211207124621301' />
</p>
</li>
<li>
<p><strong>고급</strong>을 클릭하고 해당 페이지로 이동을 선택합니다.</p>
<p>







<img class="img-fluid1" src="../images/image-20211207124712582.png" alt='image-20211207124712582' />
</p>
</li>
<li>
<p>브라우저 주소창 메뉴를 통해 인증서 정보를 확인합니다. Self-Signed 인증서로 루트 인증서가 신뢰할 수 없다는 경고를 확인할 수 있습니다.</p>
<p>







<img class="img-fluid1" src="../images/image-20211207125115259.png" alt='image-20211207125115259' />
</p>
<p>







<img class="img-fluid1" src="../images/image-20211207125154597.png" alt='image-20211207125154597' />
</p>
</li>
</ol>
<h2 id="lets-encrypt--cert-manager-사용하기">Let&rsquo;s Encrypt &amp; Cert Manager 사용하기</h2>
<p>Let&rsquo;s Encrypt는 무료 인증서 발급 사이트로 TLS에 사용할 인증서를 발급 받을 수 있습니다. 대신 90일 동안만 유효하며 만료전에 갱신해야 합니다. Kubernetes에서는 Cert Manager를 통해 자동으로 갱신할 수 있습니다.</p>
<ul>
<li><a href="https://letsencrypt.org/2015/11/09/why-90-days.html">https://letsencrypt.org/2015/11/09/why-90-days.html</a></li>
</ul>
<p>설치 참고 문서</p>
<ul>
<li><a href="https://cert-manager.io/docs/tutorials/acme/ingress/">https://cert-manager.io/docs/tutorials/acme/ingress/</a></li>
</ul>
<h3 id="cert-manager-배포">Cert Manager 배포</h3>
<ol>
<li>
<p>Cloud Shell 또는 작업환경에서 Cert Manager를 배포합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.6.1/cert-manager.yaml
</code></pre></div></li>
<li>
<p>설치 확인</p>
<p>cert-manager namespace에 자원들이 정상 실행중인 확인합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">oke_admin@cloudshell:~ <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ kubectl get all -n cert-manager
NAME                                          READY   STATUS    RESTARTS   AGE
pod/cert-manager-55658cdf68-sk5nj             1/1     Running   <span class="m">0</span>          18s
pod/cert-manager-cainjector-967788869-b77w2   1/1     Running   <span class="m">0</span>          18s
pod/cert-manager-webhook-7b86bc6578-pnxtg     1/1     Running   <span class="m">0</span>          18s

NAME                           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
service/cert-manager           ClusterIP   10.96.100.11   &lt;none&gt;        9402/TCP   19s
service/cert-manager-webhook   ClusterIP   10.96.212.15   &lt;none&gt;        443/TCP    19s

NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cert-manager              1/1     <span class="m">1</span>            <span class="m">1</span>           19s
deployment.apps/cert-manager-cainjector   1/1     <span class="m">1</span>            <span class="m">1</span>           19s
deployment.apps/cert-manager-webhook      1/1     <span class="m">1</span>            <span class="m">1</span>           19s

NAME                                                DESIRED   CURRENT   READY   AGE
replicaset.apps/cert-manager-55658cdf68             <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       19s
replicaset.apps/cert-manager-cainjector-967788869   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       19s
replicaset.apps/cert-manager-webhook-7b86bc6578     <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       18s
</code></pre></div></li>
</ol>
<h3 id="lets-encrypt-issuer-구성">Let&rsquo;s Encrypt Issuer 구성</h3>
<p>본 예제에서는 Let&rsquo;s Encrypt에서 제공하는 Staging Issuer, Production Issuer을 사용할 수 있습니다. 여기서는 테스트용도로 Staging Issuer를 사용하겠습니다.</p>
<ol>
<li>
<p>Let&rsquo;s Encrypt Staging Issuer 설정</p>
<p><a href="https://cert-manager.io/docs/tutorials/acme/example/staging-issuer.yaml">https://cert-manager.io/docs/tutorials/acme/example/staging-issuer.yaml</a> 파일에서 <strong>email 부분만 본인 것으로 수정</strong>하여 반영합니다.</p>
<p>네임스페이스에만 사용되는  Issuer가 아닌 전체 쿠버네티스 클러스터에 사용하기 위해 ClusterIssuer 유형을 사용합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="c"># Email address used for ACME registration</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">class</span><span class="p">:</span><span class="w">  </span><span class="l">nginx</span><span class="w">
</span></code></pre></div></li>
<li>
<p>Let&rsquo;s Encrypt Production Issuer</p>
<p>Production Issuer도 <a href="https://cert-manager.io/docs/tutorials/acme/example/production-issuer.yaml">https://cert-manager.io/docs/tutorials/acme/example/production-issuer.yaml</a> 파일을 이용해 동일한 방식으로 설치할 수 있습니다. 다만 사용 limit로 인해 삭제, 생성을 반복할 경우 Rate Limit에 걸릴 수 있습니다.</p>
</li>
<li>
<p>설정 적용</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">oke_admin@cloudshell:$ <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ kubectl create --edit -f https://cert-manager.io/docs/tutorials/acme/example/staging-issuer.yaml
issuer.cert-manager.io/letsencrypt-staging created
</code></pre></div></li>
</ol>
<h3 id="tls-ingress-자원-배포-1">TLS Ingress 자원 배포</h3>
<ol>
<li>
<p>테스트 앱은 이전 그대로 사용합니다.</p>
</li>
<li>
<p>ingress 설정 YAML(<code>tls-termination-cert-manager.yaml</code>)을 작성합니다.</p>
<ul>
<li><strong>문서 작성일 기준 (STAGING) Doctored Durian Root CA의 만료로 인해 staging issuer 사용시에도 유효하지 않은 인증서라고 나올 수 있습니다.</strong> cert manager issuer는 production issuer를 사용하겠습니다. 대신 production issuer는 생성을 반복할 경우 limit에 걸릴 수 있습니다.</li>
<li>cert-manager.io/cluster-issuer: 방금 생성한 letsencrypt-staging 설정, issuer가 아닌 cluster-issuer를 사용합니다.</li>
<li>spec.tls 하위에 tls 저장할 저장소 이름 및 발급받아 사용할 도메인 이름을 지정합니다</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-tls-termination-cert-manager</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;letsencrypt-staging&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-thekoguryo-ml-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">green.ingress.thekoguryo.ml</span><span class="w">
</span><span class="w">    </span>- <span class="l">blue.ingress.thekoguryo.ml</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">green.ingress.thekoguryo.ml</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-green-svc</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">blue.ingress.thekoguryo.ml</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-blue-svc</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></div></li>
<li>
<p>기존 테스트 ingress는 삭제하고, 작성한 <code>tls-termination-cert-manager.yaml</code>을 배포합니다.</p>
<pre tabindex="0"><code>oke_admin@cloudshell:ingress-nginx (ap-seoul-1)$ kubectl apply -f tls-termination-cert-manager.yaml 
ingress.networking.k8s.io/ingress-tls-termination-cert-manager created
oke_admin@cloudshell:ingress-nginx (ap-seoul-1)$ kubectl get ingress
NAME                                   CLASS    HOSTS                                                    ADDRESS   PORTS     AGE
ingress-tls-termination-cert-manager   &lt;none&gt;   blue.ingress.thekoguryo.ml,green.ingress.thekoguryo.ml             80, 443   9s
</code></pre></li>
<li>
<p>인증서 발급 확인</p>
<p>지정한 spec.tls.secretName으로 secret이 만들어지고, certificate 상태(READY)가 True가 되면 정상 발급되었습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">oke_admin@cloudshell:ingress-nginx <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ kubectl get secret
NAME                        TYPE                                  DATA   AGE
default-token-jbv7p         kubernetes.io/service-account-token   <span class="m">3</span>      3d19h
ingress-thekoguryo-ml-tls   kubernetes.io/tls                     <span class="m">2</span>      15m
letsencrypt-staging         Opaque                                <span class="m">1</span>      16m
oke_admin@cloudshell:ingress-nginx <span class="o">(</span>ap-seoul-1<span class="o">)</span>$ kubectl get certificate
NAME                        READY   SECRET                      AGE
ingress-thekoguryo-ml-tls   True    ingress-thekoguryo-ml-tls   16m
</code></pre></div></li>
</ol>
<h3 id="tls-적용-결과-검증-1">TLS 적용 결과 검증</h3>
<ol>
<li>
<p>ingress rule에서 적용한 host 명으로 각각 접속하여 결과를 확인합니다.</p>
<p>아래와 같이 https로 접속되고 Self-Signed 인증서와 달리 경고 없이 유효한 인증서로 표시됩니다.</p>
<p>







<img class="img-fluid1" src="../images/image-20211207185839881.png" alt='image-20211207185839881' />
</p>
<p>







<img class="img-fluid1" src="../images/image-20211207185954775.png" alt='image-20211207185954775' />
</p>
</li>
<li>
<p>DNS 대체 주소에 요청한 host가 모두 등록되어, blue 앱도 인증에러 없이 접속됩니다.</p>
<p>







<img class="img-fluid1" src="../images/image-20211207190233212.png" alt='image-20211207190233212' />
</p>
</li>
</ol>
<h3 id="lets-encrypt-root-ca-변경으로-인해-인증오류-해결">Let&rsquo;s Encrypt Root CA 변경으로 인해 인증오류 해결</h3>
<ol>
<li>
<p>Staging Issuer를 사용할 경우, (STAGING) Doctored Durian Root CA X3 만료로 인해 웹브라우저 접속했을 때 인증 오류가 발생하는 경우가 있습니다. Production Issuer는 해당 문제가 발생하지 않습니다.</p>
<p>







<img class="img-fluid1" src="../images/image-20211207190731003.png" alt='image-20211207190731003' />
</p>
</li>
<li>
<p>해당 에러가 발생하는 경우 변경된 새 Root CA를 let&rsquo;s encrypt 사이트에서 다운 받아 브라우저에 등록해 줍니다.</p>
</li>
<li>
<p>파일 다운로드</p>
<p><a href="https://letsencrypt.org/certs/staging/letsencrypt-stg-root-x1.pem">https://letsencrypt.org/certs/staging/letsencrypt-stg-root-x1.pem</a></p>
</li>
<li>
<p>브라우저에 다운받은 Root CA 추가(크롬 브라우저 기준)</p>
<ul>
<li>
<p><strong>크롬 브라우저</strong> &gt; <strong>설정</strong> &gt; 개인정보 및 보안 &gt; <strong>인증서 관리</strong> 로 이동</p>
</li>
<li>
<p>인증서 가져오기 클릭</p>
<p>







<img class="img-fluid1" src="../images/image-20211207190758097.png" alt='image-20211207190758097' />
</p>
</li>
<li>
<p>다운받은 파일 선택</p>
<p>







<img class="img-fluid1" src="../images/image-20211207190827049.png" alt='image-20211207190827049' />
</p>
</li>
<li>
<p>인증서 설치</p>
<p>







<img class="img-fluid1" src="../images/image-20211207190845774.png" alt='image-20211207190845774' />
</p>
</li>
<li>
<p>인증서 등록후 확인</p>
<p>신뢰할 수 있는 루트 인증 기관에 방금 등록한 (STAGING) 인증서가 보임</p>
<p>







<img class="img-fluid1" src="../images/image-20211207190923997.png" alt='image-20211207190923997' />
</p>
</li>
<li>
<p>인증서가 등록후 다시 앱의 웹페이지를 접속하면 인증오류가 발생하지 않고, 인증 경로가 아래와 같이 보이게 됩니다.</p>
<p>







<img class="img-fluid1" src="../images/image-20211207185954775.png" alt='image-20211207185954775' />
</p>
</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>참고 링크</p>
<p><a href="https://github.com/vancluever/terraform-provider-acme/issues/161">https://github.com/vancluever/terraform-provider-acme/issues/161</a></p>
</li>
</ul>
<br>
<br>
<em>** 이 글은 개인으로서, 개인의 시간을 할애하여 작성된 글입니다. 글의 내용에 오류가 있을 수 있으며, 글 속의 의견은 개인적인 의견입니다. **</em>

 <div class="edit-meta">Last updated on 7 Dec 2021<br></div><nav class="pagination"><a class="nav nav-prev" href="https://thekoguryo.github.io/oci-cloudnative/oss/ingress-controller/2.nginx-ingress-host/" title="4.1.2 NGINX Ingress Controller에서 host 기반 라우팅(feat. OCI DNS)"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - 4.1.2 NGINX Ingress Controller에서 host 기반 라우팅(feat. OCI DNS)</a>
<a class="nav nav-next" href="https://thekoguryo.github.io/oci-cloudnative/oss/logging-efk/" title="4.2 Logging - EFK">Next - 4.2 Logging - EFK <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav><footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://github.com/thingsym/hugo-theme-techdoc">TechDoc</a>. Design by <a href="https://www.thingslabo.com/">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">
<nav>
<ul>


<li>
  <form method="get" action="https://thekoguryo.github.io/oci-cloudnative/search">
    <input type="text" id="search-box" name="q" placeholder="Search"/>
  </form>
  
  <script type="text/javascript">
    $(document).ready(function() {
      $('#search-box').val($('#search-query').val());
    });
  </script>
</li>
<li><a> </a></li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oke/">
    1. OKE(Oracle Container Engine for Kubernetes)
    <button type="button" class="toggleButton">
      <span class="right  hidden">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down " >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class="">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/1.oke/">1.1 OKE(Oracle Container Engine for Kubernetes) 소개</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/2.install-quick-oke-cluster/">1.2 OKE 클러스터 만들기</a></li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oke/3.access-cluster/">
    1.3 OKE 클러스터 연결하기
    <button type="button" class="toggleButton">
      <span class="right ">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down  hidden" >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class=" hidden">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/3.access-cluster/1.cloudshell-access/">1.3.1 Cloud Shell로 클러스터 연결하기</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/3.access-cluster/2.local-access/">1.3.2 로컬 환경에서 클러스터 연결하기</a></li>
</ul>
  
</li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/4.deploy-docker-hub-image-with-lb/">1.4 앱 배포 및 Load Balancer 사용하기</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/5.deploy-ocir-image/">1.5 OCIR 이미지 사용하기</a></li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oke/6.persistent-volume/">
    1.6 Persistent Volume 사용하기
    <button type="button" class="toggleButton">
      <span class="right ">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down  hidden" >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class=" hidden">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/6.persistent-volume/1.block-volume/">1.6.1 Block Volume 사용하기</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/6.persistent-volume/2.file-storage/">1.6.2 File Storage 사용하기</a></li>
</ul>
  
</li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/7.supported-version-and-upgrade/">1.7 Kubernetes 버전 업그레이드</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oke/8.monitor-application-log/">1.8 애플리케이션 로그 모니터링</a></li>
</ul>
  
</li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/devops/">
    2. DevOps(관리형 CI/CD) 서비스 사용하기
    <button type="button" class="toggleButton">
      <span class="right  hidden">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down " >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class="">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/devops/1.deploy-app-on-oke-using-devops/">2.1 DevOps 서비스를 이용한 Spring Boot 앱을 OKE에 배포 자동화하기</a></li>
</ul>
  
</li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/ocir/">
    3. OCIR(Oracle Cloud Infrastructure Registry) 컨테이너 레지스트리
    <button type="button" class="toggleButton">
      <span class="right  hidden">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down " >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class="">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/ocir/1.scan-image/">3.1 컨테이너 이미지 스캔</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/ocir/2.helm-chart/">3.2 Helm Chart Repostory로 사용하기</a></li>
</ul>
  
</li>



<li class="parent has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oss/">
    4. OSS(Open Source Software) 사용하기
    <button type="button" class="toggleButton">
      <span class="right  hidden">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down " >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class="sub-menu">



<li class="parent has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oss/ingress-controller/">
    4.1 Ingress Controller
    <button type="button" class="toggleButton">
      <span class="right  hidden">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down " >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class="sub-menu">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oss/ingress-controller/1.install-nginx-ingress-controller/">4.1.1 NGINX Ingress Controller 사용하기</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oss/ingress-controller/2.nginx-ingress-host/">4.1.2 NGINX Ingress Controller에서 host 기반 라우팅(feat. OCI DNS)</a></li>
<li class="active"><a href="https://thekoguryo.github.io/oci-cloudnative/oss/ingress-controller/3.nginx-ingress-tls-termination/">4.1.3 NGINX Ingress Controller에서 TLS termination</a></li>
</ul>
  
</li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oss/logging-efk/">
    4.2 Logging - EFK
    <button type="button" class="toggleButton">
      <span class="right ">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down  hidden" >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class=" hidden">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oss/logging-efk/1.install-efk/">4.2.1 EFK 설치하기</a></li>
</ul>
  
</li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oss/monitoring/">
    4.3 Monitoring - Prometheus&amp;Grafana
    <button type="button" class="toggleButton">
      <span class="right ">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down  hidden" >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class=" hidden">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oss/monitoring/1.install-prometheus-grafana/">4.3.1 Prometheus&amp;Grafana 설치하기</a></li>
</ul>
  
</li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oss/service-mesh/">
    4.4 Service Mesh - Istio
    <button type="button" class="toggleButton">
      <span class="right ">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down  hidden" >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class=" hidden">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oss/service-mesh/1.sampleapp-without-istio/">4.4.1 Service Mesh 없는 마이크로서비스 앱 배포</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oss/service-mesh/2.sampleapp-with-istio/">4.4.2 마이크로서비스 앱에 Service Mesh - Istio 적용하기</a></li>
</ul>
  
</li>
</ul>
  
</li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/oracle-oss/">
    5. Oracle Open Source 사용하기
    <button type="button" class="toggleButton">
      <span class="right  hidden">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down " >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class="">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/oracle-oss/1.oci-service-operator/">5.1 OCI Service Operator for Kubernetes(OSOK)</a></li>
</ul>
  
</li>



<li class=" has-sub-menu">
  <a href="https://thekoguryo.github.io/oci-cloudnative/verrazzano/">
    6. Verrazzano 사용하기
    <button type="button" class="toggleButton">
      <span class="right  hidden">
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-right">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="7 4 13 10 7 16"></polyline>
        </svg></span>
      <span class="down " >
        <svg width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-svg="chevron-down">
          <polyline fill="none" stroke="#000" stroke-width="1.03" points="16 7 10 13 4 7"></polyline>
        </svg>
      </span>
    </button>
  </a>
<ul class="">
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/verrazzano/1.install-verrazzano/">6.1 Verrazzano 설치</a></li>
<li class=""><a href="https://thekoguryo.github.io/oci-cloudnative/verrazzano/2.deploy-app/">6.2 Open Application Model 이해 및 예제 애플리케이션 배포하기</a></li>
</ul>
  
</li>
</ul>
</nav>


<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>

<script src="https://thekoguryo.github.io/oci-cloudnative/js/copy-code-button.js"></script></div>
</body>
</html>
